"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[382],{5318:function(e,t,a){a.d(t,{Zo:function(){return p},kt:function(){return m}});var n=a(7378);function s(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){s(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function r(e,t){if(null==e)return{};var a,n,s=function(e,t){if(null==e)return{};var a,n,s={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(s[a]=e[a]);return s}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(s[a]=e[a])}return s}var l=n.createContext({}),c=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},p=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,s=e.mdxType,i=e.originalType,l=e.parentName,p=r(e,["components","mdxType","originalType","parentName"]),d=c(a),m=s,h=d["".concat(l,".").concat(m)]||d[m]||u[m]||i;return a?n.createElement(h,o(o({ref:t},p),{},{components:a})):n.createElement(h,o({ref:t},p))}));function m(e,t){var a=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var i=a.length,o=new Array(i);o[0]=d;var r={};for(var l in t)hasOwnProperty.call(t,l)&&(r[l]=t[l]);r.originalType=e,r.mdxType="string"==typeof e?e:s,o[1]=r;for(var c=2;c<i;c++)o[c]=a[c];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},9864:function(e,t,a){a.r(t),a.d(t,{assets:function(){return p},contentTitle:function(){return l},default:function(){return m},frontMatter:function(){return r},metadata:function(){return c},toc:function(){return u}});var n=a(2685),s=a(1244),i=(a(7378),a(5318)),o=["components"],r={title:"Great Tests",sidebar_position:4},l=void 0,c={unversionedId:"goals/great-tests",id:"goals/great-tests",title:"Great Tests",description:"Joist focuses not just on great production code & business logic, but also on great testing of that business logic, by facilitating tests that are:",source:"@site/docs/goals/great-tests.md",sourceDirName:"goals",slug:"/goals/great-tests",permalink:"/docs/goals/great-tests",draft:!1,editUrl:"https://github.com/stephen/joist-ts/edit/main/docs/docs/goals/great-tests.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{title:"Great Tests",sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Type-Safe Relations",permalink:"/docs/goals/type-safe-relations"},next:{title:"Nullable Columns",permalink:"/docs/modeling/nullable-columns"}},p={},u=[{value:"Isolated Tests",id:"isolated-tests",level:2},{value:"Succinct Tests",id:"succinct-tests",level:2},{value:"Fast Enough Tests",id:"fast-enough-tests",level:2},{value:"What is &quot;Fast Enough?&quot;",id:"what-is-fast-enough",level:4}],d={toc:u};function m(e){var t=e.components,a=(0,s.Z)(e,o);return(0,i.kt)("wrapper",(0,n.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"Joist focuses not just on great production code & business logic, but also on great testing of that business logic, by facilitating tests that are:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Isolated,"),(0,i.kt)("li",{parentName:"ol"},"Succinct, and"),(0,i.kt)("li",{parentName:"ol"},"Fast")),(0,i.kt)("h2",{id:"isolated-tests"},"Isolated Tests"),(0,i.kt)("p",null,'Isolation is an important tenant of great tests, because generally any sort of "shared fixtures", "shared environment", etc. that couples automated tests to an ever-growing, ever-changing shared test data eventually becomes very confusing to debug and very brittle to change.'),(0,i.kt)("p",null,"With Joist, each unit test starts out with a clean database, and so is concerned only with the minimum amount of data it needs for its boundary case."),(0,i.kt)("p",null,"I.e. when you run:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},'describe("Author", () => {\n  it("can have rule one", async () => {\n    const em = newEntityManager();\n    const a1 = em.create(Author, { firstName: "a1" });\n    await em.flush();\n  });\n\n  it("can have rule two", async () => {\n    const em = newEntityManager();\n    const a1 = em.create(Author, { firstName: "a1" });\n    await em.flush();\n  });\n});\n')),(0,i.kt)("p",null,"Each ",(0,i.kt)("inlineCode",{parentName:"p"},"it")," block will see a clean/fresh database."),(0,i.kt)("p",null,"This is achieved by running a ",(0,i.kt)("inlineCode",{parentName:"p"},"flush_database")," stored procedure in ",(0,i.kt)("inlineCode",{parentName:"p"},"beforeEach"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},'beforeEach(async () => {\n  await knex.select(knex.raw("flush_database()"));\n});\n')),(0,i.kt)("p",null,"Where the ",(0,i.kt)("inlineCode",{parentName:"p"},"flush_database")," stored procured:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Is a single database invocation, so cheap to invoke"),(0,i.kt)("li",{parentName:"ol"},"Knows the difference between entity tables and enum tables, and only ",(0,i.kt)("inlineCode",{parentName:"li"},"TRUNCATE"),"s entity tables"),(0,i.kt)("li",{parentName:"ol"},"Resets sequences to restart from 1"),(0,i.kt)("li",{parentName:"ol"},"Is only created in local testing environments, not production")),(0,i.kt)("h2",{id:"succinct-tests"},"Succinct Tests"),(0,i.kt)("p",null,'Given each test starts with a clean database, Joist provides factories to easily create test data, so that the benefit of "a clean database" is not negated by lots of boilerplate code to re-create test data.'),(0,i.kt)("p",null,"Factories can:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Accept values that are important to the test case being tested,"),(0,i.kt)("li",{parentName:"ol"},"Fill in defaults for any other required fields/columns,"),(0,i.kt)("li",{parentName:"ol"},'Also accept specific hints/flags to create re-usable "chunks" of data')),(0,i.kt)("p",null,"For example, if you want to test an author with a book of the same name/title:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},'const a1 = newAuthor({\n  firstName: "a1",\n  books: [{ title: "a1" }],\n});\n')),(0,i.kt)("p",null,"If either the ",(0,i.kt)("inlineCode",{parentName:"p"},"Author")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"Book")," had other required fields, the ",(0,i.kt)("inlineCode",{parentName:"p"},"newAuthor")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"newBook")," factories will apply them as needed."),(0,i.kt)("p",null,"See the ",(0,i.kt)("a",{parentName:"p",href:"/docs/testing/test-factories"},"factories")," for more information on custom flags."),(0,i.kt)("h2",{id:"fast-enough-tests"},"Fast Enough Tests"),(0,i.kt)("p",null,"Slow tests can kill productivity and dis-incentivize testing in general, so Joist tries to make tests as fast as possible."),(0,i.kt)("p",null,"Joist does not have a specific approach/feature that enables fast tests, other than:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The ",(0,i.kt)("inlineCode",{parentName:"li"},"flush_database")," stored procedure makes db resets a single database call instead of ",(0,i.kt)("inlineCode",{parentName:"li"},"N")," calls (i.e. 1 per table in your schema)"),(0,i.kt)("li",{parentName:"ul"},"Using build-time code generation means Joist does not need to scan the schema at runtime/boot time.")),(0,i.kt)("p",null,"In small projects, you can generally expect:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"A single file takes ~1 second to run (Jest will report ~100ms, but real time is higher)"),(0,i.kt)("li",{parentName:"ul"},"Individual ",(0,i.kt)("inlineCode",{parentName:"li"},"it")," test cases take ~10ms to run")),(0,i.kt)("p",null,"In larger projects (i.e. 100-150 tables), you can expect:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"A single file takes ~5 seconds to run (Jest will report ~1.5 seconds, but real time is higher)"),(0,i.kt)("li",{parentName:"ul"},"Individual ",(0,i.kt)("inlineCode",{parentName:"li"},"it")," test cases take ~50ms to run")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},'Note that the "5 seconds of wall clock time" for large projects, and in general the discrepancy between Jest time vs. actual wall clock time, can be mitigated by projects like ',(0,i.kt)("inlineCode",{parentName:"p"},"@swc/jest")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"@swc-node/register"),", as in larger projects the bottleneck becomes Node ",(0,i.kt)("inlineCode",{parentName:"p"},"require"),"/",(0,i.kt)("inlineCode",{parentName:"p"},"import"),"-ing source code and transpiling the TypeScript to JavaScript, instead of Joist / the database operations themselves."))),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"When running Postgres locally for testing, you can run ",(0,i.kt)("inlineCode",{parentName:"p"},"postgres -c fsync=off")," (i.e. passed as the ",(0,i.kt)("inlineCode",{parentName:"p"},"command")," in your ",(0,i.kt)("inlineCode",{parentName:"p"},"docker-compose.yml"),' file) to put Postgres into a "sort of" in-memory mode, that is faster because transactions will not commit to disk before completing.'))),(0,i.kt)("h4",{id:"what-is-fast-enough"},'What is "Fast Enough?"'),(0,i.kt)("p",null,'Granted, compared to true in-memory unit tests, these tests times are still ~5-10x slower, but the goal is that they are still "fast enough" given the benefit of still using the real database.'),(0,i.kt)("p",null,"Sometimes applications will choose to mock out all database calls, with the goal of having strictly zero I/O calls during unit tests; granted, sometimes this approach can make sense, i.e. a frontend codebase mocking all GraphQL calls makes sense. But, for testing domain entities that are fundamentally tied to the database schema & persistence layer, it's generally more pragmatic with Joist to just keep testing against the real database."),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Joist has explored an ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/stephenh/joist-ts/blob/main/packages/orm/src/drivers/InMemoryDriver.ts"},"InMemoryDriver"),', that could potentially achieve "no I/O calls during unit tests", with the idea that building this complexity into Joist itself might justify/amortize its expense, instead of complicating each application\'s architecture.'),(0,i.kt)("p",{parentName:"div"},"However, so far the ",(0,i.kt)("inlineCode",{parentName:"p"},"InMemoryDriver")," is not actually 10x faster than real Postgres tests (it's maybe ~2-3x), and also does not support custom SQL queries, so for now its development is on pause. Rebooting it on top of ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/oguimbal/pg-mem"},"pg-mem")," might be fun, to get custom SQL query support."))))}m.isMDXComponent=!0}}]);