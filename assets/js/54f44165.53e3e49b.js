"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[152],{5318:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return d}});var a=n(7378);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),m=p(n),d=o,g=m["".concat(l,".").concat(d)]||m[d]||c[d]||i;return n?a.createElement(g,r(r({ref:t},u),{},{components:n})):a.createElement(g,r({ref:t},u))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,r[1]=s;for(var p=2;p<i;p++)r[p]=n[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},3846:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return l},default:function(){return d},frontMatter:function(){return s},metadata:function(){return p},toc:function(){return c}});var a=n(2685),o=n(1244),i=(n(7378),n(5318)),r=["components"],s={title:"Installation",slug:"/getting-started",sidebar_position:0},l=void 0,p={unversionedId:"getting-started/installation",id:"getting-started/installation",title:"Installation",description:"Installing Joist in your project has four main steps:",source:"@site/docs/getting-started/installation.md",sourceDirName:"getting-started",slug:"/getting-started",permalink:"/docs/getting-started",draft:!1,editUrl:"https://github.com/stephen/joist-ts/edit/main/docs/docs/getting-started/installation.md",tags:[],version:"current",sidebarPosition:0,frontMatter:{title:"Installation",slug:"/getting-started",sidebar_position:0},sidebar:"tutorialSidebar",next:{title:"Schema Assumptions",permalink:"/docs/getting-started/schema-assumptions"}},u={},c=[{value:"Setting up your database",id:"setting-up-your-database",level:2},{value:"Setting up migrations",id:"setting-up-migrations",level:3},{value:"Setting up <code>joist-codegen</code>",id:"setting-up-joist-codegen",level:2},{value:"Setting up your tests",id:"setting-up-your-tests",level:2},{value:"Setting up your production code",id:"setting-up-your-production-code",level:2}],m={toc:c};function d(e){var t=e.components,n=(0,o.Z)(e,r);return(0,i.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"Installing Joist in your project has four main steps:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Setting up your database"),(0,i.kt)("li",{parentName:"ol"},"Setting up ",(0,i.kt)("inlineCode",{parentName:"li"},"joist-codegen")),(0,i.kt)("li",{parentName:"ol"},"Setting up your tests"),(0,i.kt)("li",{parentName:"ol"},"Setting up your production code")),(0,i.kt)("p",null,"A wrinkle is that each Node.js application can be pretty different, in terms of how you manage your local database (i.e. with Docker Compose), what your production application looks like (a REST API, a GraphQL API, etc.), etc."),(0,i.kt)("p",null,"So, to simplify this page, we'll include some assumptions based on the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/stephenh/joist-ts-sample"},"Joist sample app"),", but you should be able to adjust these steps to your specific project. "),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"If you want a faster intro than this page, you should be able to check out the sample app, run the commands in its readme, and just start poking around."))),(0,i.kt)("h2",{id:"setting-up-your-database"},"Setting up your database"),(0,i.kt)("p",null,"The sample app uses ",(0,i.kt)("inlineCode",{parentName:"p"},"docker-compose")," and a ",(0,i.kt)("inlineCode",{parentName:"p"},"db.dockerfile")," file to manage the local Postgres database. "),(0,i.kt)("p",null,"To start it, clone the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/stephenh/joist-ts-sample"},"sample app"),", and run:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"docker-compose build db\ndocker-compose up -d db\n")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"docker-compose.yml")," exposes the ",(0,i.kt)("inlineCode",{parentName:"p"},"sample_app")," database on port ",(0,i.kt)("inlineCode",{parentName:"p"},"5346"),", so it is accessible with an environment variable of:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-env"},"DATABASE_URL=postgres://sample_user:local@localhost:5436/sample_app\n")),(0,i.kt)("p",null,"The following steps will assume your database is available at this location (it is already set in the sample app's ",(0,i.kt)("inlineCode",{parentName:"p"},"env/local.env")," file), but you can set ",(0,i.kt)("inlineCode",{parentName:"p"},"DATABASE_URL")," to whatever is appropriate for your application."),(0,i.kt)("h3",{id:"setting-up-migrations"},"Setting up migrations"),(0,i.kt)("p",null,"You should also set up a migrations library to manage your database schema; the Joist sample app uses ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/salsita/node-pg-migrate"},"node-pg-migrate"),". "),(0,i.kt)("p",null,"If you want to use ",(0,i.kt)("inlineCode",{parentName:"p"},"node-pg-migrate")," as well, you can install Joist's ",(0,i.kt)("inlineCode",{parentName:"p"},"node-pg-migrate"),"-based helper methods:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"npm add --save-dev joist-migration-utils\n")),(0,i.kt)("p",null,"And add ",(0,i.kt)("inlineCode",{parentName:"p"},"joist-migrate")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"joist-new-migration")," commands to your ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "scripts": {\n    "joist-migrate": "./run.sh ./node_modules/joist-migration-utils",\n    "joist-new-migration": "npx node-pg-migrate create"\n  }\n}\n')),(0,i.kt)("p",null,"The sample app uses a ",(0,i.kt)("inlineCode",{parentName:"p"},"run.sh")," helper script to load the environment variables from ",(0,i.kt)("inlineCode",{parentName:"p"},"env/local.env")," before running ",(0,i.kt)("inlineCode",{parentName:"p"},"joist-migration-utils"),", but if you don't like that, you can manage your application's environment variables however you like."),(0,i.kt)("p",null,"Now we can apply any migrations by running:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"npm run joist-migrate\n")),(0,i.kt)("p",null,"The sample app also supports resetting the database schema (so you can re-run the migrations from scratch) by running:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"docker-compose exec db ./reset.sh\n")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Joist is agnostic to your migration tool and will codegen based on your database schema, however it happens to be managed. You're welcome to use ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/salsita/node-pg-migrate"},"node-pg-migrate"),", Knex's ",(0,i.kt)("a",{parentName:"p",href:"http://knexjs.org/guide/migrations.html#migration-cli"},"migrations"),", or another tool for migrations/schema management."))),(0,i.kt)("h2",{id:"setting-up-joist-codegen"},"Setting up ",(0,i.kt)("inlineCode",{parentName:"h2"},"joist-codegen")),(0,i.kt)("p",null,"Install the ",(0,i.kt)("inlineCode",{parentName:"p"},"joist-codegen")," package as a dev dependency and add a ",(0,i.kt)("inlineCode",{parentName:"p"},"joist-codegen")," script to your ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"npm add --save-dev joist-codegen\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "scripts": {\n    "joist-codegen": "./run.sh ./node_modules/joist-codegen"\n  }\n}\n')),(0,i.kt)("p",null,"This again uses the ",(0,i.kt)("inlineCode",{parentName:"p"},"run.sh")," script, as ",(0,i.kt)("inlineCode",{parentName:"p"},"joist-codegen")," will use the ",(0,i.kt)("inlineCode",{parentName:"p"},"DATABASE_URL")," environment variable to connect to your local database."),(0,i.kt)("p",null,"Now, anytime you make schema changes (i.e. by running ",(0,i.kt)("inlineCode",{parentName:"p"},"npm run joist-migrate"),"), you can also run ",(0,i.kt)("inlineCode",{parentName:"p"},"joist-codegen")," to get the latest code:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"npm run joist-codegen\n")),(0,i.kt)("h2",{id:"setting-up-your-tests"},"Setting up your tests"),(0,i.kt)("p",null,"We want each test to get a clean/fresh database, so we should set up a ",(0,i.kt)("inlineCode",{parentName:"p"},"beforeEach")," to invoke our local-only ",(0,i.kt)("inlineCode",{parentName:"p"},"flush_database")," command:"),(0,i.kt)("p",null,"The sample app does this via a ",(0,i.kt)("inlineCode",{parentName:"p"},"setupTests.ts")," file that will be used for all tests:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},'import { EntityManager } from "src/entities";\nimport { knex as createKnex, Knex } from "knex";\nimport { PostgresDriver } from "joist-orm";\nimport { newPgConnectionConfig } from "joist-utils";\n\nlet knex: Knex;\n\nfunction getKnex(): Knex {\n  return (knex ??= createKnex({\n    client: "pg",\n    connection: newPgConnectionConfig() as any,\n    debug: false,\n    asyncStackTraces: true,\n  }));\n}\n\nexport function newEntityManager(): EntityManager {\n  return new EntityManager({}, new PostgresDriver(getKnex()));\n}\n\nbeforeEach(async () => {\n  const knex = await getKnex();\n  await knex.select(knex.raw("flush_database()"));\n});\n\nafterAll(async () => {\n  if (knex) {\n    await knex.destroy();\n  }\n});\n')),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"newPgConnectionConfig")," helper method from ",(0,i.kt)("inlineCode",{parentName:"p"},"joist-utils")," also uses the ",(0,i.kt)("inlineCode",{parentName:"p"},"DATABASE_URL")," environment variable, which we can have loaded into the Jest process by using ",(0,i.kt)("inlineCode",{parentName:"p"},"dotenv")," in a ",(0,i.kt)("inlineCode",{parentName:"p"},"setupTestEnv.js")," file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},'import { config } from "dotenv";\n\nexport default () => {\n  if (process.env.STAGE === undefined) {\n    config({ path: "./env/local.env" });\n  }\n};\n')),(0,i.kt)("p",null,"And then configure ",(0,i.kt)("inlineCode",{parentName:"p"},"jest.config.js")," to use both files:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},'module.exports = {\n    preset: "ts-jest",\n    globalSetup: "<rootDir>/src/setupTestEnv.ts",\n    setupFilesAfterEnv: ["<rootDir>/src/setupTests.ts"],\n    testMatch: ["<rootDir>/src/**/*.test.{ts,tsx,js,jsx}"],\n    moduleNameMapper: {\n        "^src(.*)": "<rootDir>/src$1",\n    },\n};\n')),(0,i.kt)("p",null,"As usual, you can/should adjust all of this to your specific project."),(0,i.kt)("p",null,"Now your unit tests should be able to create an ",(0,i.kt)("inlineCode",{parentName:"p"},"EntityManager")," and work with the domain objects:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},'import { Author, EntityManager, newAuthor } from "src/entities";\nimport { newEntityManager } from "src/setupTests";\n\ndescribe("Author", () => {\n  it("can be created", async () => {\n    const em = newEntityManager();\n    const a = new Author(em, { firstName: "a1" });\n    await em.flush();\n  });\n});\n')),(0,i.kt)("h2",{id:"setting-up-your-production-code"},"Setting up your production code"),(0,i.kt)("p",null,"Finally, you can use the ",(0,i.kt)("inlineCode",{parentName:"p"},"EntityManager")," and your domain objects in your production code."),(0,i.kt)("p",null,'This is where the guide really becomes "it depends on your application", but in theory it will look very similar to setting up the tests:'),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Configure a single/global ",(0,i.kt)("inlineCode",{parentName:"li"},"knex")," instance that will act as the connection pool,"),(0,i.kt)("li",{parentName:"ol"},"For each request, create a new ",(0,i.kt)("inlineCode",{parentName:"li"},"EntityManager")," to perform that request's work ")),(0,i.kt)("p",null,"An extremely simple example might look like:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"import { EntityManager, Author } from './entities';\nimport { newPgConnectionConfig, PostgresDriver } from 'joist-orm';\nimport { knex as createKnex, Knex } from 'knex';\n\n// Create our global knex connection\nlet knex: Knex = createKnex({\n  client: 'pg',\n  connection: newPgConnectionConfig(),\n  debug: false,\n  asyncStackTraces: true,\n});\n\n// Create a helper method for our requests to create a new EntityManager\nfunction newEntityManager(): EntityManager {\n  return new EntityManager({}, new PostgresDriver(getKnex()));\n}\n\n// Handle GET `/authors`\napp.get('/authors', async (req, res) => {\n  // Create a new em\n  const em = newEntityManager();\n  // Find all authors\n  const authors = await em.find(Author, {});\n  // Send them back as JSON\n  res.send(authors);\n});\n")),(0,i.kt)("p",null,"Note that you'll again need the ",(0,i.kt)("inlineCode",{parentName:"p"},"DATABASE_URL")," environment variable set, but that will depend on whatever hosting provider you're using to run the app."),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"In the above code, the ",(0,i.kt)("inlineCode",{parentName:"p"},"newPgConnectionConfig")," is the only method that depends on ",(0,i.kt)("inlineCode",{parentName:"p"},"DATABASE_URL")," being set, so if you don't want to use an environment variable at all, or have multiple environment variables set (",(0,i.kt)("inlineCode",{parentName:"p"},"DB_USER"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"DB_PASSWORD"),", etc.) you can create the ",(0,i.kt)("inlineCode",{parentName:"p"},"knex")," instance/connection information however you'd like."))))}d.isMDXComponent=!0}}]);